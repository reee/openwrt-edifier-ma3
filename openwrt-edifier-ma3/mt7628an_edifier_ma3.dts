/dts-v1/;

#include "mt7628an.dtsi"

#include <dt-bindings/gpio/gpio.h>
#include <dt-bindings/input/input.h>

/ {
	/*
	 * Linkplay A31 + TAS5717 Audio Board DTS
	 * Modified for I2S Master Mode & TAS5717 Support
	 * Hardware: A-TAS5717-07 V1.0 Carrier
	 */

	compatible = "linkplay,a31", "mediatek,mt7628an-soc";
	model = "Linkplay A31 with TAS5717";

	chosen {
		bootargs = "console=ttyS1,57600";
	};

	aliases {
		serial0 = &uart1;
		serial1 = &uartlite;
	};

	/* 
	 * 音频子系统配置 - 重构部分
	 * 使用 simple-audio-card 驱动来桥接 MT7628 I2S 与 TAS5717
	 */
	sound {
		compatible = "simple-audio-card";
		simple-audio-card,name = "Linkplay-TAS5717";
		simple-audio-card,format = "i2s";
		
		/* 
		 * 主从模式设定：
		 * 指向CPU节点(&dailink0_master)，表示CPU产生BCLK和LRCK。
		 * TAS5717作为Slave接收时钟。
		 */
		simple-audio-card,bitclock-master = <&dailink0_master>;
		simple-audio-card,frame-master = <&dailink0_master>;
		
		/* 
		 * MCLK设定：
		 * TAS5717需要系统时钟。配置为采样率的256倍。
		 * MT7628将通过REFCLK引脚输出此频率(如12.288MHz)。
		 */
		simple-audio-card,mclk-fs = <256>;

		/* 定义音频控件组件 */
		simple-audio-card,widgets =
			"Speaker", "External Speaker";
			
		/* 音频路由：将放大器输出连接到虚拟扬声器组件 */
		simple-audio-card,routing =
			"External Speaker", "OUT_A",
			"External Speaker", "OUT_B",
			"External Speaker", "OUT_C",
			"External Speaker", "OUT_D";

		/* CPU侧配置 */
		dailink0_master: simple-audio-card,cpu {
			sound-dai = <&i2s>;
		};

		/* Codec侧配置：引用下方定义的tas5717节点 */
		simple-audio-card,codec {
			sound-dai = <&tas5717>;
		};
	};
};

&state_default {
	/* PCB GPIOs 1-5 映射到 MCU 引脚 14-18 => Linux 494-498 */
	pwm0 {
		groups = "pwm0";
		function = "gpio";
	};

	spis {
		groups = "spis";
		function = "gpio";
	};
};

&spi0 {
	status = "okay";

	pinctrl-names = "default";
	pinctrl-0 = <&spi_pins>, <&spi_cs1_pins>;

	flash@0 {
		compatible = "jedec,spi-nor";
		reg = <0>;
		spi-max-frequency = <40000000>;

		partitions {
			compatible = "fixed-partitions";
			#address-cells = <1>;
			#size-cells = <1>;

			partition@0 {
				label = "u-boot";
				reg = <0x0 0x30000>;
				read-only;
			};

			partition@30000 {
				label = "u-boot-env";
				reg = <0x30000 0x10000>;
			};

			factory: partition@40000 {
				label = "factory";
				reg = <0x40000 0x10000>;
				read-only;
			};

			partition@50000 {
				label = "bkKernel";
				reg = <0x50000 0x200000>;
				read-only;
			};

			/*
			 * 固件分区布局调整：合并原有的小分区以适应OpenWrt
			 */
			partition@250000 {
				compatible = "denx,uimage";
				label = "firmware";
				reg = <0x250000 0xdb0000>;
			};
		};
	};

	spidev@1 {
		#address-cells = <1>;
		#size-cells = <1>;
		compatible = "linux,spidev";
		reg = <1>;
		spi-max-frequency = <40000000>;
	};
};

/* 
 * I2S控制器配置 
 * 必须确保 pinctrl 包含 refclk_pins 以输出MCLK
 */
&i2s {
	#sound-dai-cells = <0>;
	status = "okay";
	pinctrl-names = "default";
	pinctrl-0 = <&i2s_pins>, <&refclk_pins>;
};

/* 
 * I2C控制器配置 - 挂载TAS5717
 */
&i2c {
	status = "okay";
	
	tas5717: audio-codec@2a {
		compatible = "ti,tas5717";
		reg = <0x2a>; /* 默认地址0x2a (A_SEL接GND) */
		#sound-dai-cells = <0>;

		/* 
		 * 硬件复位引脚配置 (根据A-TAS5717-07实际连线启用)
		 * 如果硬件已做上拉处理，可保持注释状态。
		 * 常见Linkplay设计可能使用GPIO 14/15/16等。
		 */
		/* reset-gpios = <&gpio 15 GPIO_ACTIVE_LOW>; */
		/* pdn-gpios = <&gpio 14 GPIO_ACTIVE_LOW>; */
	};
};

&gdma {
	status = "okay";
	/* 注意：确保DMA控制器已启用，否则音频播放将卡死或无声 */
};

&uart1 {
	status = "okay";
};

&pwm {
	status = "okay";
};

&ethernet {
	nvmem-cells = <&macaddr_factory_eth_2e>;
	nvmem-cell-names = "mac-address";
};

&wmac {
	status = "okay";
	mediatek,mtd-eeprom = <&factory 0x0>;
};

&factory {
	compatible = "nvmem-cells";
	#address-cells = <1>;
	#size-cells = <1>;

	macaddr_factory_wifi_4: macaddr@4 {
		reg = <0x4 0x6>;
	};
	macaddr_factory_wifi_28: macaddr@28 {
		reg = <0x28 0x6>;
	};
	macaddr_factory_eth_2e: macaddr@2e {
		reg = <0x2e 0x6>;
	};
};